<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <MSBuildExtensionsPath>C:\Program Files\MSBuild</MSBuildExtensionsPath>
  </PropertyGroup>
  <!-- Import MSBuildExtensionsPack -->
  <Import Project="$(MSBuildExtensionsPath)\ExtensionPack\4.0\MSBuild.ExtensionPack.tasks"/>

  <!-- Names of all projects -->
  <PropertyGroup>
    <TestDeploy>TestDeploy</TestDeploy>
    <TestDeployTests>TestDeploy.Tests</TestDeployTests>
    <Configuration Condition="$(Configuration) == ''">Test</Configuration>
    <PublishProfile Condition="$(PublishProfile) == ''">Test</PublishProfile>
    <OutputDir>.out</OutputDir>
    <NUnitConsole>packages\NUnit.Console.3.0.1\tools\nunit3-console.exe</NUnitConsole>
  </PropertyGroup>

  <ItemGroup>
    <!-- All projects -->
    <Projects Include="$(TestDeploy)" />

    <!-- Test projects -->
    <TestProjects Include="$(TestDeployTests)" />
  </ItemGroup>

  <Target Name="CreateDirectories">
    <MakeDir Directories="$(OutputDir)"/>
    <MakeDir Directories="$(OutputDir)\Package"/>
    <MakeDir Directories="$(TestDeploy)\obj\Package"/>
  </Target>

  <Target Name="Clean" DependsOnTargets="CreateDirectories">
    <MSBuild.ExtensionPack.FileSystem.Folder
      TaskAction="RemoveContent"
      Path="$(OutputDir)"/>
    <MSBuild.ExtensionPack.FileSystem.Folder
    TaskAction="RemoveContent"
    Path="$(TestDeploy)\obj\Package"/>
  </Target>

  <!-- Compiles and Cleans all projects (if named correctly) -->
  <Target Name="Build" DependsOnTargets="Clean">
    <PropertyGroup>
      <CurrentProject>%(Projects.Identity)</CurrentProject>
    </PropertyGroup>

    <MSBuild Projects="$(CurrentProject)\$(CurrentProject).csproj"
      Targets="Clean;Build"
      Properties="Configuration=$(Configuration)" />
  </Target>


  <Target Name="Package" DependsOnTargets="Build">

    <MSBuild Projects="$(TestDeploy)\$(TestDeploy).csproj"
      Properties="Configuration=$(Configuration);DeployOnBuild=True;PublishProfile=$(PublishProfile)" />

    <ItemGroup>
      <OutputFiles Include="$(TestDeploy)\obj\Package\**\*.*"/>
    </ItemGroup>

    <Copy
      SourceFiles="@(OutputFiles)"
      DestinationFiles="@(OutputFiles->'.out\Package\%(RecursiveDir)%(Filename)%(Extension)')"
        />
    
  </Target>

</Project>